# 3.2.2.1. UC-US-01: Quản lý thiết lập tài khoản (Manage Account)

## 1. Đặc tả Use Case

| Mục | Nội dung |
| :--- | :--- |
| **Mã UC** | UC-US-01 |
| **Tên UC** | Quản lý thiết lập tài khoản (Manage Account) |
| **Mô tả** | Người dùng xem trang cá nhân (Wall), cập nhật thông tin hồ sơ (Profile) và thay đổi mật khẩu đăng nhập. |
| **Tác nhân sử dụng** | User |
| **Sự kiện kích hoạt** | Người dùng chọn menu "My Profile" hoặc "Settings" từ giao diện ứng dụng. |
| **Luồng sự kiện chính** | **1. Xem hồ sơ cá nhân (View Wall)**<br>1. User truy cập URL `/profile/me`.<br>2. Hệ thống gọi `GET /api/profiles/me`: Lấy thông tin hiển thị (Avatar, Bio).<br>3. Hệ thống gọi `GET /api/posts/profile/{id}`: Lấy danh sách bài viết.<br>4. Hiển thị giao diện Wall Page.<br><br>**2. Cập nhật thông tin (Update Info)**<br>1. User chọn "Edit Profile".<br>2. Nhập DisplayName, Bio mới, chọn Avatar mới.<br>3. Nhấn "Save".<br>4. Hệ thống gọi `PUT /api/profiles`: `ProfileService` validate và cập nhật bảng `Profiles`.<br>5. Hệ thống trả về 200 OK -> Giao diện cập nhật thông tin mới.<br><br>**3. Đổi mật khẩu (Change Password)**<br>1. User chọn chức năng "Change Password".<br>2. Nhập Mật khẩu cũ và Mật khẩu mới.<br>3. Hệ thống gọi `POST /api/auth/change-password`:<br>   - `AuthService` kiểm tra hash mật khẩu cũ.<br>   - Hash mật khẩu mới và cập nhật bảng `Users`.<br>4. Trả về 200 OK -> Thông báo "Password changed". |
| **Luồng sự kiện phụ** | **A1. Sai mật khẩu cũ (Change Password)**:<br>- API trả về 401 Unauthorized (`WRONG_PASSWORD`).<br>- Hệ thống hiển thị lỗi "Mật khẩu cũ không chính xác".<br><br>**A2. File Avatar quá lớn (>5MB)**:<br>- API trả về 400 Bad Request (`INVALID_FILE`).<br>- Hệ thống báo "File too large".<br><br>**A3. Lỗi kết nối Database**:<br>- Service timeout/exception -> API trả về 500 Internal Server Error.<br>- Hệ thống ghi Log và báo "System Error". |
| **Yêu cầu trước khi thực hiện** | Người dùng đã đăng nhập (Token hợp lệ). |
| **Yêu cầu sau khi thực hiện** | Dữ liệu `Profiles` hoặc `Users` được cập nhật đồng bộ. |
| **Yêu cầu phi chức năng** | Upload ảnh phải hoàn tất < 3s. |

## 2. Biểu đồ

### 2.1. Activity Diagram (Tổng quát)
```plantuml
@startuml
|User|
start
:Truy cập trang Quản lý tài khoản;
if (Chọn hành động?) then (Xem Wall)
    :Click Avatar/Tên;
    |System|
    :API GET /api/profiles/me;
    :API GET /api/posts/profile;
    :Trả về Info & Posts;
    |User|
    :Hiển thị Wall Page;
    stop
elseif (Sửa thông tin) then (Edit Profile)
    |User|
    :Nhập DisplayName, Bio, Avatar;
    :Click Save;
    |System|
    :API PUT /api/profiles;
    :Validate Input;
    if (Hợp lệ?) then (Yes)
        :Update DB Profiles;
        :Return 200 OK;
    else (No)
        :Return 400 Error;
    endif
    stop
else (Đổi mật khẩu)
    |User|
    :Nhập Pass cũ + mới;
    :Click Change;
    |System|
    :API POST /auth/change-password;
    :Verify Old Pass;
    if (Correct?) then (Yes)
        :Hash New Pass;
        :Update DB Users;
        :Return 200 OK;
    else (No)
        :Return 401 Unauthorized;
    endif
    stop
endif
@enduml
```

### 2.2. Sequence Diagram (Tổng quát)
```plantuml
@startuml
autonumber
actor User
participant UI
participant "Backend API" as API
participant "Service Layer" as Service
participant DB

User -> UI: Truy cập Account Settings
UI -> User: Hiển thị Menu (Info, Password)

alt Update Profile Info
    User -> UI: Nhập Info mới -> Save
    UI -> API: PUT /api/profiles
    API -> Service: UpdateProfileAsync()
    Service -> DB: Update Profiles Info
    DB --> Service: Success
    Service --> API: 200 OK
    API --> UI: Hiển thị thông báo thành công
else Change Password
    User -> UI: Nhập Pass cũ/mới -> Save
    UI -> API: POST /api/auth/change-password
    API -> Service: ChangePasswordAsync()
    Service -> DB: Get User
    Service -> Service: Verify & Hash
    alt Valid
        Service -> DB: Update PasswordHash
        DB --> Service: Success
        Service --> API: 200 OK
        API --> UI: Thông báo thành công
    else Invalid
        Service --> API: 401 Unauthorized
        API --> UI: Báo lỗi sai mật khẩu
    end
else View Wall
    User -> UI: Click View Profile
    UI -> API: GET /api/profiles/me
    API --> UI: Profile Data
end
@enduml
```
