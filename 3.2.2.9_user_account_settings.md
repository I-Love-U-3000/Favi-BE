# 3.2.2.9. UC-US-09: Cài đặt tài khoản (User Account Settings)

## 1. Đặc tả Use Case

| Mục | Nội dung |
| :--- | :--- |
| **Mã UC** | UC-US-09 |
| **Tên UC** | Cài đặt tài khoản (User Account Settings) |
| **Mô tả** | Người dùng thực hiện thay đổi giao diện (Theme), ngôn ngữ hiển thị và cài đặt các quyền riêng tư (Privacy) cho tài khoản cá nhân. |
| **Tác nhân sử dụng** | User |
| **Sự kiện kích hoạt** | Người dùng chọn menu "Settings" hoặc biểu tượng bánh răng từ trang cá nhân. |
| **Luồng sự kiện chính** | **1. Đổi Giao diện (Change Theme)**<br>1. User truy cập tab "Appearance".<br>2. User chọn theme mong muốn từ danh sách.<br>3. Hệ thống Client apply ngay bộ màu sắc mới (CSS Variables).<br>4. Hệ thống lưu cấu hình vào LocalStorage.<br><br>**2. Đổi Ngôn ngữ (Change Language)**<br>1. User truy cập tab "Language".<br>2. User chọn ngôn ngữ: Tiếng Việt hoặc English.<br>3. Hệ thống Client tải bộ resource ngôn ngữ tương ứng.<br>4. Giao diện làm mới (reload text) để hiển thị ngôn ngữ đã chọn.<br>5. Lưu cấu hình vào LocalStorage.<br><br>**3. Cài đặt Quyền riêng tư (Privacy Settings)**<br>1. User chọn tab "Privacy".<br>2. Chỉnh sửa quyền:<br>   - **Profile Visibility**: Public/Friend/Private.<br>   - **Message**: Ai có thể nhắn tin (Everyone/Follower/Nobody).<br>   - **Interaction**: Ai xem được danh sách Follower/Following.<br>3. Nhấn "Save Changes".<br>4. Hệ thống gọi `PUT /api/profiles/me/privacy` để cập nhật Database.<br>5. Trả về 200 OK -> Thông báo "Privacy updated". |
| **Luồng sự kiện phụ** | **A1. Lỗi Validation Privacy (400)**:<br>- Nếu giá trị Privacy không hợp lệ (ngoài enum cho phép).<br>- API trả về lỗi `INVALID_VALUE`.<br>- Hệ thống báo "Giá trị cài đặt không hợp lệ".<br><br>**A2. Lỗi Hệ thống (500)**:<br>- Không lưu được vào Database.<br>- API trả về 500.<br>- Hệ thống báo "Vui lòng thử lại sau". |
| **Yêu cầu trước khi thực hiện** | Tài khoản đang ở trạng thái đăng nhập. |
| **Yêu cầu sau khi thực hiện** | Các cấu hình mới được áp dụng và lưu lại cho lần đăng nhập sau. |
| **Yêu cầu phi chức năng** | Thay đổi Theme/Language phải phản hồi tức thì (< 100ms). |

## 2. Biểu đồ

### 2.1. Activity Diagram (Tổng quát)
```plantuml
@startuml
!theme plain
|User|
start
:Truy cập Settings Page;
if (Chọn hành động?) then (Đổi Giao diện)
    :Chọn giao diện (Theme);
    |System|
    :Cập nhật CSS Variables;
    if (Lỗi lưu Cache?) then (Yes)
        |User|
        :Báo lỗi "Không lưu được cấu hình";
        stop
    else (No)
        |System|
        :Lưu Preference (Local);
        |User|
        :Giao diện đổi màu;
        stop
    endif
elseif (Đổi Ngôn ngữ) then (Change Language)
    :Chọn ngôn ngữ từ List;
    |System|
    :Tải Resource (JSON);
    if (Tải thành công?) then (Yes)
        :Update Text UI;
        :Lưu Preference (Local);
        |User|
        :Hiển thị ngôn ngữ mới;
        stop
    else (No)
        |System|
        :Log Error;
        |User|
        :Báo lỗi "Tải ngôn ngữ thất bại";
        stop
    endif
else (Chỉnh Privacy)
    :Chọn mức riêng tư;
    :Click Save Changes;
    |System|
    :API PUT /api/profiles/me/privacy;
    :Validate Input;
    if (Hợp lệ?) then (Yes)
        :Update DB Profiles;
        if (DB Error/Timeout?) then (Yes)
            :Return 500 Server Error;
            |User|
            :Thông báo lỗi hệ thống;
            stop
        else (No)
            :Return 200 OK;
            |User|
            :Thông báo "Đã lưu";
            stop
        endif
    else (No)
        |System|
        :Return 400 Bad Request;
        |User|
        :Thông báo "Giá trị không hợp lệ";
        stop
    endif
endif
@enduml
```

### 2.2. Sequence Diagram (Tổng quát)
```plantuml
@startuml
!theme plain
autonumber
actor User
participant UI
participant "Backend API" as API
participant "Service Layer" as Service
participant DB

User -> UI: Truy cập Settings

alt Change Theme
    User -> UI: Chọn Theme
    UI -> UI: Update CSS Variables
    alt Save Error
        UI -> UI: Catch Exception (LocalStorage Full)
        UI --> User: Alert "Cannot save settings"
    else Success
        UI -> UI: Save to LocalStorage
        UI --> User: Giao diện mới hiển thị
    end
else Change Language
    User -> UI: Chọn Ngôn ngữ
    UI -> UI: Fetch Resource (JSON)
    alt Network Error / 404
        UI --> User: Alert "Load Language Failed"
    else Success
        UI -> UI: Translate Text
        UI -> UI: Save LocalStorage
        UI --> User: Giao diện ngôn ngữ mới
    end
else Update Privacy
    User -> UI: Chỉnh Privacy -> Save
    UI -> API: PUT /api/profiles/me/privacy
    API -> Service: UpdatePrivacyAsync(uid, data)
    Service -> DB: Get Profile
    Service -> Service: Validate Enums
    
    alt Invalid Value
        Service --> API: 400 Bad Request
        API --> UI: Error "Invalid Privacy Level"
    else Valid
        Service -> DB: Update Fields
        alt DB Error
            DB --> Service: Exception
            Service --> API: 500 Internal Server Error
            API --> UI: Error "System Error"
        else Success
            DB --> Service: Success
            Service --> API: 200 OK
            API --> UI: Toast "Settings Saved"
        end
    end
end
@enduml
```
