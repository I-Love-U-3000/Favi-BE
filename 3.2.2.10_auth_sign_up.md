# 3.2.2.10. UC-US-10: Đăng ký tài khoản (Sign Up)

## 1. Đặc tả Use Case

| Mục | Nội dung |
| :--- | :--- |
| **Mã UC** | UC-US-10 |
| **Tên UC** | Đăng ký tài khoản (Sign Up) |
| **Mô tả** | Cho phép khách (Guest) tạo tài khoản mới để truy cập hệ thống bằng Email và Mật khẩu. |
| **Tác nhân sử dụng** | Guest (Khách vãng lai) |
| **Sự kiện kích hoạt** | Người dùng nhấn nút "Đăng ký" (Register) trên màn hình Login hoặc Landing Page. |
| **Luồng sự kiện chính** | **1. Khởi tạo đăng ký**<br>1. Guest truy cập trang `/register`.<br>2. Nhập: Email, Username, Password, Confirm Password.<br>3. Hệ thống Client validate format (Email đúng định dạng, Pass >= 6 ký tự).<br>4. Nhấn "Sign Up".<br><br>**2. Xử lý đăng ký**<br>1. Hệ thống gọi `POST /api/auth/register`.<br>2. `AuthService` kiểm tra Email tồn tại (qua Supabase) và Username tồn tại (qua DB nội bộ).<br>3. Gọi Supabase Auth để tạo User (Identity).<br>4. Tạo bản ghi `Profile` mặc định trong DB Favi (Avatar mặc định, Role User).<br>5. Trả về 201 Created.<br>6. Hiển thị thông báo "Đăng ký thành công", chuyển về trang Login. |
| **Luồng sự kiện phụ** | **A1. Email hoặc Username đã tồn tại (409)**:<br>- API check Duplicate trả về 409 Conflict.<br>- Hệ thống báo "Email hoặc Username đã được sử dụng".<br><br>**A2. Lỗi kết nối bên thứ 3 (502)**:<br>- Không gọi được Supabase API.<br>- Hệ thống báo "Service Unavailable". |
| **Yêu cầu trước khi thực hiện** | Email chưa được sử dụng trong hệ thống. |
| **Yêu cầu sau khi thực hiện** | Tài khoản User và Profile được khởi tạo. |
| **Yêu cầu phi chức năng** | Mật khẩu phải được mã hóa (Hash) bởi Identity Provider. |

## 2. Biểu đồ

### 2.1. Activity Diagram (Tổng quát)
```plantuml
@startuml
!theme plain
|Guest|
start
:Truy cập trang Đăng ký;
:Nhập Email, User, Pass;
:Click Sign Up;
|System|
:Validate Input & Check Duplicate;
if (Thông tin không hợp lệ/Trùng?) then (Yes)
    :Return 400/409 Error;
    |Guest|
    :Hiển thị lỗi;
    stop
else (No)
    |System|
    :Call Supabase CreateUser;
    :Create DB Profile;
    if (Lỗi hệ thống?) then (Yes)
        :Log Error;
        :Return 500 Error;
        |Guest|
        :Báo lỗi "Đăng ký thất bại";
        stop
    else (No)
        |System|
        :Return 201 Created;
        |Guest|
        :Thông báo thành công;
        :Redirect Login;
        stop
    endif
endif
@enduml
```

### 2.2. Sequence Diagram (Tổng quát)
```plantuml
@startuml
!theme plain
autonumber
actor Guest
participant UI
participant "AuthController" as API
participant "SupabaseService" as Auth
participant DB

Guest -> UI: Nhập thông tin -> Sign Up
UI -> API: POST /api/auth/register

API -> DB: Validate Information (Duplicate?)
alt Invalid / Duplicate
    DB --> API: True/Error
    API --> UI: 400/409 Error
else Valid
    API -> Auth: CreateUser(email, pass)
    API -> DB: Create Profile(Uid)
    
    alt System Error (Auth/DB)
        API -> API: Log Error
        API --> UI: 500 Internal Server Error
        UI -> Guest: Alert "System Error"
    else Success
        DB --> API: Success
        API --> UI: 201 Created
        UI -> Guest: Redirect Login
    end
end
@enduml
```
