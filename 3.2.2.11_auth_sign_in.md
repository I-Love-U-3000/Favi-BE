# 3.2.2.11. UC-US-11: Đăng nhập & Quên mật khẩu (Sign In & Forgot Password)

## 1. Đặc tả Use Case

| Mục | Nội dung |
| :--- | :--- |
| **Mã UC** | UC-US-11 |
| **Tên UC** | Đăng nhập & Quên mật khẩu (Sign In & Forgot Password) |
| **Mô tả** | Người dùng xác thực danh tính để truy cập hệ thống, hoặc yêu cầu đặt lại mật khẩu khi quên. |
| **Tác nhân sử dụng** | Guest |
| **Sự kiện kích hoạt** | Truy cập trang Login, hoặc nhấn "Forgot Password". |
| **Luồng sự kiện chính** | **1. Đăng nhập (Sign In)**<br>1. Guest nhập Email và Password.<br>2. Nhấn "Log in".<br>3. Hệ thống gọi `POST /api/auth/login`.<br>4. `AuthService` chuyển tiếp thông tin tới Supabase để xác thực.<br>5. Nếu đúng: Trả về Access Token + Refresh Token.<br>6. Hệ thống lấy thông tin Profile từ DB để trả về Client.<br>7. Client lưu Token và chuyển hướng vào Home.<br><br>**2. Quên mật khẩu (Forgot Password)**<br>1. Guest chọn "Forgot Password".<br>2. Nhập Email đăng ký.<br>3. Nhấn "Send Reset Link".<br>4. Hệ thống gọi `POST /api/auth/reset-password`: Supabase gửi email chứa link đặt lại.<br>5. Thông báo "Kiểm tra email của bạn". |
| **Luồng sự kiện phụ** | **A1. Sai thông tin đăng nhập (401)**:<br>- Supabase trả về lỗi Invalid Credentials.<br>- API trả về 401.<br>- Hiển thị "Email hoặc mật khẩu không đúng".<br><br>**A2. Tài khoản bị khóa (403)**:<br>- Kiểm tra cột `IsBanned` trong bảng `Profiles`.<br>- Nếu true -> Trả về 403 Forbidden kèm lý do/ngày mở khóa.<br>- Hiển thị "Tài khoản của bạn đã bị khóa". |
| **Yêu cầu trước khi thực hiện** | Tài khoản đã tồn tại và chưa bị khóa vĩnh viễn. |
| **Yêu cầu sau khi thực hiện** | Client nhận được JWT Token hợp lệ. |
| **Yêu cầu phi chức năng** | Bảo mật: Token không được lộ ra ngoài (HTTPS). |

## 2. Biểu đồ

### 2.1. Activity Diagram (Tổng quát)
```plantuml
@startuml
!theme plain
|Guest|
start
if (Quên mật khẩu?) then (Yes)
    :Chọn Forgot Password;
    :Nhập Email;
    |System|
    :API POST /reset-password;
    :Gửi Email Reset (Supabase);
    |Guest|
    :Nhận Email & Đặt lại Pass;
    stop
else (No)
    :Nhập Email, Pass;
    :Click Login;
    |System|
    :API POST /auth/login;
    :Verify Credential (Supabase);
    if (OK?) then (Yes)
        :Check Ban Status;
        if (Banned?) then (Yes)
            :Return 403 Forbidden;
            |Guest|
            :Hiện lỗi Banned;
            stop
        else (No)
            :Get Profile Info;
            :Return Token + Profile;
            |Guest|
            :Redirect Home;
            stop
        endif
    else (No)
        |System|
        :Return 401 Unauthorized;
        |Guest|
        :Hiện lỗi sai Pass;
    endif
endif
stop
@enduml
```

### 2.2. Sequence Diagram (Tổng quát)
```plantuml
@startuml
!theme plain
autonumber
actor Guest
participant UI
participant "AuthController" as API
participant "SupabaseService" as Auth
participant DB

alt Sign In Flow
    Guest -> UI: Login(email, pass)
    UI -> API: POST /auth/login
    API -> Auth: SignIn(email, pass)
    alt Invalid
        Auth --> API: Error
        API --> UI: 401 Unauthorized
    else Success
        Auth --> API: Token, Uid
        API -> DB: GetProfile(Uid)
        alt Banned
            DB --> API: Profile (IsBanned=true)
            API --> UI: 403 Forbidden
        else Active
            DB --> API: Profile Data
            API --> UI: 200 OK (Token, Profile)
            UI -> Guest: Redirect Home
        end
    end
else Forgot Password
    Guest -> UI: RequestReset(email)
    UI -> API: POST /auth/reset
    API -> Auth: SendResetEmail(email)
    Auth --> API: Success
    API --> UI: 200 OK
    UI -> Guest: Alert "Check Email"
end
@enduml
```
