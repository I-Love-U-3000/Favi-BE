# 3.2.2.8. UC-US-08: Trò chuyện (Chat System)

## 1. Đặc tả Use Case

| Mục | Nội dung |
| :--- | :--- |
| **Mã UC** | UC-US-08 |
| **Tên UC** | Trò chuyện (Chat System) |
| **Mô tả** | Người dùng gửi và nhận tin nhắn riêng (DM) hoặc nhóm (Group) theo thời gian thực. |
| **Tác nhân sử dụng** | User |
| **Sự kiện kích hoạt** | User nhấn "Message" trên Profile hoặc vào trang Chat. |
| **Luồng sự kiện chính** | **1. Khởi tạo hội thoại (DM)**<br>1. User chọn gửi tin nhắn cho User B.<br>2. Hệ thống gọi `POST /api/chat/dm` (`otherProfileId`).<br>3. Nếu chưa có, tạo mới `Conversation`. Trả về ID.<br><br>**2. Gửi tin nhắn (Send)**<br>1. User nhập nội dung -> Gửi.<br>2. Hệ thống gọi `POST /api/chat/{id}/messages`.<br>3. Server lưu DB và push SignalR `ReceiveMessage` tới thành viên khác.<br><br>**3. Nhận tin nhắn & Đọc**<br>1. User nhận tin qua SignalR.<br>2. Khi xem tin, API gọi `POST /api/chat/{id}/read`.<br>3. Reset Unread Count. |
| **Luồng sự kiện phụ** | **A1. Bị chặn (Blocked)**:<br>- Gửi tin cho người đã chặn mình -> API trả về 403 Forbidden.<br>- UI báo "Không thể gửi tin nhắn".<br><br>**A2. File quá lớn**:<br>- Upload ảnh/video > 20MB -> Trả về 400 Bad Request. |
| **Yêu cầu trước khi thực hiện** | Đã đăng nhập. |
| **Yêu cầu sau khi thực hiện** | Tin nhắn được lưu trữ vĩnh viễn (trừ khi xóa). |

## 2. Biểu đồ

### 2.1. Activity Diagram (Tổng quát)
```plantuml
@startuml
|User|
start
:Mở Chat Window;
if (Hành động?) then (Gửi tin)
    :Nhập content -> Send;
    |System|
    :API POST /messages;
    :Check Block?;
    if (Blocked?) then (Yes)
        :Return 403;
    else (No)
        :Save DB;
        :SignalR PushToOthers;
        :Return 200 OK;
    endif
    stop
else (Tạo DM mới)
    |System|
    :API POST /chat/dm;
    :Find/Create Conversation;
    :Return ID;
    stop
endif
@enduml
```

### 2.2. Sequence Diagram (Tổng quát)
```plantuml
@startuml
autonumber
actor User
participant UI
participant API
participant Service
participant DB
participant SignalR

alt Init Conversation
    User -> UI: Click User B -> Message
    UI -> API: POST /chat/dm
    API -> Service: GetOrCreate()
    Service -> DB: Query
    DB --> API: ConversationId
    API --> UI: Open Chat Box
else Send Message
    User -> UI: Input -> Send
    UI -> API: POST /messages
    API -> Service: SendAsync()
    Service -> DB: Save Msg
    Service -> SignalR: Push Event
    API --> UI: Sent Success
else Receive Message
    SignalR -> H_User: ReceiveMessage(DTO)
    H_User -> UI: Render Msg
end
@enduml
```
