# 3.2.2. Đặc tả Use Case User

Chi tiết các chức năng dành cho Người dùng thường (User), tuân thủ định dạng đặc tả chi tiết và sử dụng sơ đồ PlantUML.

## 3.2.2.1. UC-US-01: Đăng nhập & Đăng ký (Authentication)

| Mã UC | UC-US-01 |
| :--- | :--- |
| **Tên UC** | Đăng nhập & Đăng ký |
| **Mô tả** | Người dùng đăng ký tài khoản mới vào hệ thống hoặc đăng nhập để được cấp quyền truy cập các chức năng dành cho thành viên. |
| **Tác nhân sử dụng** | Guest (Khách), User |
| **Sự kiện kích hoạt** | Người dùng mở ứng dụng Favi lần đầu hoặc chọn "Logout" trước đó. |
| **Luồng sự kiện chính** | **A. Luồng Đăng nhập (Sign In)**<br>1. Người dùng nhập Username/Email và Password.<br>2. Nhấn nút "Login".<br>3. Hệ thống mã hóa mật khẩu và so khớp với CSDL.<br>4. Nếu hợp lệ, hệ thống tạo JWT Token và Refresh Token.<br>5. Chuyển hướng người dùng vào trang Newsfeed.<br><br>**B. Luồng Đăng ký (Sign Up)**<br>1. Người dùng chọn "Create Account".<br>2. Nhập Email, Tên hiển thị, Mật khẩu.<br>3. Nhấn "Register".<br>4. Hệ thống kiểm tra sự tồn tại của Email.<br>5. Tạo tài khoản mới với trạng thái Active.<br>6. Tự động đăng nhập và chuyển hướng. |
| **Luồng sự kiện phụ** | **A1. Sai mật khẩu quá 5 lần**: Hệ thống khóa tạm thời IP (Rate Limit) trong 15 phút.<br>**A2. Email đã tồn tại**: Báo lỗi "Email is already taken" khi đăng ký.<br>**A3. Lỗi xác thực Token**: Khi Token hết hạn, User được chuyển về trang Login. |
| **Yêu cầu trước khi thực hiện** | Người dùng có kết nối Internet. |
| **Yêu cầu sau khi thực hiện** | Access Token được lưu ở LocalStorage/Cookie; User Profile được lưu vào Global State. |
| **Yêu cầu phi chức năng** | Bảo mật mật khẩu (Hash Bcrypt); Token chuẩn JWT HS256/RS256. |

##### **Sơ đồ hoạt động**

```plantuml
@startuml
|User|
start
:Mở trang Login;
if (Đã có tài khoản?) then (Yes)
    :Nhập Email + Password;
    :Click "Login";
else (No)
    :Click "Register";
    :Nhập thông tin cá nhân;
    :Click "Submit";
endif

|System|
if (Action == Login) then
    :AuthController.Login();
    :Kiểm tra Password Hash;
    if (Khớp?) then (Yes)
        :Tạo JWT Token;
        :Trả về 200 OK;
    else (No)
        :Trả về 401 Unauthorized;
        stop
    endif
else
    :AuthController.Register();
    :Kiểm tra trùng Email;
    if (Trùng?) then (Yes)
        :Báo lỗi Email tồn tại;
        stop
    else (No)
        :Tạo User mới;
        :Lưu vào DB;
        :Tự động Login;
    endif
endif

:Chuyển hướng vào Newsfeed;
stop
@enduml
```

##### **Sơ đồ tuần tự (Login)**

```plantuml
@startuml
autonumber
actor User
participant "Login Page" as UI
participant "AuthController" as API
participant "AuthService" as Service
participant "Database" as DB

User -> UI: Nhập Email/Pass -> Submit
UI -> API: POST /api/auth/login
note right: Body: { email, password }

API -> Service: Authenticate(email, pass)
Service -> DB: GetUserByEmail(email)
DB --> Service: UserEntity (w/ PasswordHash)

Service -> Service: VerifyPassword(pass, hash)

alt Password Correct
    Service -> Service: GenerateTokens(user)
    Service -> DB: Update LastLoginTime
    Service --> API: AuthResponse {Token, RefreshToken}
    API --> UI: 200 OK
    UI -> User: Redirect to Home
else Incorrect
    Service --> API: Null / Error
    API --> UI: 401 Unauthorized
    UI -> User: Hiển thị lỗi thông tin
end
@enduml
```

## 3.2.2.2. UC-US-02: Quản lý bài viết (Manage Post)

| Mã UC | UC-US-02 |
| :--- | :--- |
| **Tên UC** | Quản lý bài viết (Manage Post) |
| **Mô tả** | Người dùng có thể đăng tải hình ảnh, viết caption, gắn thẻ (tag) và quản lý (sửa/xóa) các bài viết mình đã tạo. |
| **Tác nhân sử dụng** | User |
| **Sự kiện kích hoạt** | Người dùng nhấn nút "+" hoặc "Create Post" trên thanh điều hướng. |
| **Luồng sự kiện chính** | **Tạo bài viết mới**<br>1. Người dùng chọn ảnh từ thiết bị.<br>2. Nhập nội dung mô tả (Caption).<br>3. (Tùy chọn) Chọn bộ lọc màu hoặc gắn thẻ bạn bè.<br>4. Nhấn "Post".<br>5. Hệ thống upload ảnh lên Cloud Storage (ví dụ: Azure Blob/AWS S3).<br>6. Hệ thống lưu metadata bài viết vào CSDL.<br>7. Bài viết xuất hiện trên Profile và Newsfeed. |
| **Luồng sự kiện phụ** | **A1. Ảnh quá khổ**: File > 10MB -> Báo lỗi và từ chối upload.<br>**A2. Định dạng không hỗ trợ**: Upload file .exe/.txt -> Báo lỗi chỉ chấp nhận .jpg/.png.<br>**A3. Nội dung vi phạm**: Chứa từ khóa cấm -> Hệ thống tự động flag hoặc từ chối đăng. |
| **Yêu cầu trước khi thực hiện** | Người dùng đã đăng nhập. |
| **Yêu cầu sau khi thực hiện** | Bài viết được lưu vĩnh viễn (trừ khi xóa); Số lượng bài post của user tăng +1. |
| **Yêu cầu phi chức năng** | Upload ảnh < 3s (mạng ổn định); Ảnh được nén tự động để tối ưu hiển thị. |

##### **Sơ đồ hoạt động**

```plantuml
@startuml
|User|
start
:Click "Create Post";
:Chọn ảnh (File Picker);
:Nhập Caption & Tag;
:Click "Share";

|System|
:Validate File (Size, Type);
if (Hợp lệ?) then (Yes)
    :Upload Image to Storage;
    :Get Image URL;
    :PostController.CreatePost();
    :Save Post to DB;
    :Trigger Notification (to Followers);
    :Return Success;
else (No)
    :Show Error Message;
    stop
endif

|User|
:Hiển thị bài viết mới trên Feed;
stop
@enduml
```

##### **Sơ đồ tuần tự (Create Post)**

```plantuml
@startuml
autonumber
actor User
participant "Post Modal UI" as UI
participant "PostController" as API
participant "PostService" as Service
participant "Cloud Storage" as Cloud
participant "Database" as DB

User -> UI: Chọn Ảnh + Caption -> Submit
UI -> API: POST /api/posts (Multipart/Form-Data)
API -> Service: CreatePost(dto, imageFile)

par Upload Ảnh
    Service -> Cloud: UploadAsync(imageFile)
    Cloud --> Service: Returns ImageURL
end

Service -> DB: Insert Post Entity (URL, Caption, UserID)
DB --> Service: New PostID

Service --> API: PostResponseDto
API --> UI: 201 Created
UI -> User: Đóng Modal & Reload Feed
@enduml
```

## 3.2.2.3. UC-US-03: Tương tác (Interact with Content)

| Mã UC | UC-US-03 |
| :--- | :--- |
| **Tên UC** | Tương tác nội dung (Like/Comment) |
| **Mô tả** | Người dùng thể hiện cảm xúc (Like/Love...) hoặc thảo luận (Comment) trên bài viết của người khác. |
| **Tác nhân sử dụng** | User |
| **Sự kiện kích hoạt** | Người dùng xem một bài viết trên Newsfeed. |
| **Luồng sự kiện chính** | 1. Người dùng xem bài viết.<br>2. **Thả tim**: Nhấn nút "Heart" -> Icon chuyển sang màu đỏ -> Số like tăng lên 1.<br>3. **Bình luận**: Nhấn icon "Comment" -> Nhập nội dung -> Nhấn Enter/Gửi -> Bình luận xuất hiện ngay lập tức bên dưới bài viết. |
| **Luồng sự kiện phụ** | **A1. Bỏ like (Unlike)**: Nhấn lại vào nút Heart -> Số like giảm đi 1.<br>**A2. Spam comment**: Gửi quá nhiều trong thời gian ngắn -> Rate limit chặn lại. |
| **Yêu cầu sau khi thực hiện** | Chủ bài viết nhận được thông báo (Notification). |

##### **Sơ đồ hoạt động**

```plantuml
@startuml
|User|
start
:Xem bài viết;
fork
    :Click Like Button;
    |System|
    :Gọi API ToggleLike;
    :Update Like Count;
fork again
    |User|
    :Nhập Bình luận -> Gửi;
    |System|
    :Validate nội dung;
    :Lưu Comment vào DB;
    :Return Comment Data;
end fork
:Gửi thông báo cho chủ bài viết;
stop
@enduml
```

##### **Sơ đồ tuần tự (Comment)**

```plantuml
@startuml
autonumber
actor User
participant "Newsfeed UI" as UI
participant "CommentsController" as API
participant "CommentService" as Service
participant "NotificationService" as Notif
participant "Database" as DB

User -> UI: Nhập comment -> Enter
UI -> API: POST /api/comments
note right: Body: { postId, content }

API -> Service: AddComment()
Service -> DB: Insert Comment
DB --> Service: Success

par Notify Owner
    Service -> DB: Get Post Owner Info
    Service -> Notif: CreateNotification(OwnerID, "User commented...")
end

Service --> API: CommentDto
API --> UI: 201 Created
UI -> User: Append comment to list
@enduml
```
