# 3.2.2.2. UC-US-02: Quản lý bài viết (Manage Post)

## 1. Đặc tả Use Case

| Mục | Nội dung |
| :--- | :--- |
| **Mã UC** | UC-US-02 |
| **Tên UC** | Quản lý bài viết (Manage Post) |
| **Mô tả** | Người dùng tạo mới, xem danh sách bài đã đăng, chỉnh sửa, xóa (soft delete) và lưu trữ (archive) bài viết cá nhân. |
| **Tác nhân sử dụng** | User |
| **Sự kiện kích hoạt** | Người dùng nhấn nút "+" (Create) hoặc chọn "Manage" trên bài viết. |
| **Luồng sự kiện chính** | **1. Tạo bài viết (Create)**<br>1. User chọn Ảnh và nhập Caption.<br>2. Hệ thống gọi `POST /api/posts`: Upload ảnh và Insert `Posts`.<br>3. Trả về 201 Created -> Hiển thị bài viết mới.<br><br>**2. Xem bài đăng của mình (View List)**<br>1. User truy cập tab "Posts" trên Wall.<br>2. Hệ thống gọi `GET /api/posts/profile/{id}`: Query bài viết (loại trừ Deleted/Archived).<br>3. Trả về danh sách phân trang.<br><br>**3. Lưu trữ (Archive)**<br>1. User chọn "Archive" trên bài viết.<br>2. Hệ thống gọi `POST /api/posts/{id}/archive`.<br>3. `PostService` kiểm tra quyền chủ sở hữu -> Set `IsArchived = true`.<br>4. Trả về 200 OK -> Ẩn bài viết khỏi Wall.<br><br>**4. Xóa bài viết (Delete)**<br>1. User chọn "Delete".<br>2. Hệ thống gọi `DELETE /api/posts/{id}`.<br>3. Set `DeletedDayExpiredAt` = Now + 30 days. |
| **Luồng sự kiện phụ** | **A1. Không có quyền (Not Owner)**:<br>- Cố tình gọi API sửa/xóa bài người khác -> API trả về 403 Forbidden (`ERR_NOT_OWNER`).<br>- Hệ thống báo lỗi "Bạn không có quyền này".<br><br>**A2. Bài viết không tồn tại (Not Found)**:<br>- Bài đã bị xóa vĩnh viễn -> API trả về 404 Not Found.<br><br>**A3. Lỗi Upload ảnh**:<br>- Cloud Storage lỗi -> API trả về 500 Internal Server Error. |
| **Yêu cầu trước khi thực hiện** | Người dùng đã đăng nhập; File upload hợp lệ (nếu có). |
| **Yêu cầu sau khi thực hiện** | Trạng thái bài viết (`IsArchived`, `DeletedDayExpiredAt`) cập nhật đúng trong DB. |
| **Yêu cầu phi chức năng** | Upload ảnh và tạo bài viết hoàn tất < 3s. |

## 2. Biểu đồ

### 2.1. Activity Diagram (Tổng quát)
```plantuml
@startuml
|User|
start
:Chọn hành động quản lý Post;
if (Tạo mới) then (Create)
    :Chọn Ảnh + Caption;
    :Submit;
    |System|
    :API POST /api/posts;
    :Upload to Cloud;
    if (Success?) then (Yes)
        :Insert DB;
        :Return 201;
    else (No)
        :Return Error;
    endif
    stop
elseif (Quản lý bài cũ) then (Edit/Delete/Archive)
    |User|
    :Chọn Post -> Chọn Action;
    |System|
    :API Call (PUT/DELETE/ARCHIVE);
    :Check Owner;
    if (Is Owner?) then (Yes)
        :Update DB Status;
        :Return 200 OK;
    else (No)
        :Return 403 Forbidden;
    endif
    stop
else (Xem danh sách)
    |User|
    :Vào Tab Posts;
    |System|
    :API GET /posts/profile;
    :Return List;
    stop
endif
@enduml
```

### 2.2. Sequence Diagram (Tổng quát)
```plantuml
@startuml
autonumber
actor User
participant UI
participant "PostController" as API
participant "PostService" as Service
participant DB

User -> UI: Chọn hành động

alt Create Post
    User -> UI: Upload Ảnh + Text
    UI -> API: POST /api/posts
    API -> Service: CreateAsync()
    Service -> DB: Check Quota & Insert
    DB --> Service: Success
    Service --> API: 201 Created
    API --> UI: Show New Post
else Archive Post
    User -> UI: Click Archive
    UI -> API: POST /archive
    API -> Service: ArchiveAsync()
    Service -> DB: Check Owner
    alt Owner
        Service -> DB: Update IsArchived=true
        DB --> Service: Success
        Service --> API: 200 OK
        API --> UI: Hide Post
    else Not Owner
        Service --> API: 403 Forbidden
        API --> UI: Show Error
    end
else View Posts
    User -> UI: Get Info
    UI -> API: GET /posts/profile
    API --> UI: List JSON
end
@enduml
```
